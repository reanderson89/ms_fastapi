name: Tag, Build & Deploy v0

on:
  push:
    branches-ignore:
      - test*

  workflow_dispatch:
    inputs:
      tag:
        description: "Deploy existing Docker tag?"
        required: true
        default: "latest"
      environment:
        description: "To which environment?"
        type: choice
        default: "dev"
        options:
          - dev
          - staging
          - prod

env:
  SWARM_YAML: "docker-milestones-api-swarm.yml"
  MILESTONES_DOCKER_REPO: "blueboardinc/milestones_api"
  DEBUG: "false" # set to true for a little more output

jobs:
  tag:
  name: Tag
  runs-on: ubuntu-latest
  if: ${{ github.event_name != 'workflow_dispatch' && ( contains(github.event.head_commit.message, 'major') || contains(github.event.head_commit.message, 'minor') || contains(github.event.head_commit.message, 'patch') ) }}
  steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}
        fetch-depth: 0
        persist-credentials: false # this must be false to use the PAT in the push below

    - name: Checkout Blueboard's Shared GitHub Actions üîß
      uses: actions/checkout@v4
      with:
        repository: blueboard/github_actions
        token: ${{ secrets.BLUEBOARD_BOT_PAT }}
        path: .github/actions

    - name: Get Next Version
      id: get-next-version
      uses: ./.github/actions/get-versions
      with:
        message: ${{ github.event.head_commit.message }}
        pat: ${{ secrets.BLUEBOARD_BOT_PAT }}

    - name: Dump GitHub context (Debugging)
      if: ${{ env.DEBUG == 'true' }}
      run: |
        echo '${{ toJSON(github) }}'

  outputs:
    environment: ${{ steps.get-next-version.outputs.environment }}
    tag: ${{ steps.get-next-version.outputs.tag }}

  build:
    name: Build
    needs:
      - tag
    runs-on: ubuntu-latest
    steps:
      - name: Echo Environment and Tag (Debugging)
        if: ${{ env.DEBUG == 'true' }}
        run: |
          echo "Environment:  ${{ needs.tag.outputs.environment }}"
          echo "Tag:  ${{ needs.tag.outputs.tag }}"

      - name: Check out the repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
          # BURP_PAT is a Personal Access Token for the BlueboardBot user that has permissions to read from the BURP repoistory
          # which allows this service to checkout the submodule
          token: ${{ secrets.BURP_PAT }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN_RW }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.MILESTONES_DOCKER_REPO }}

      - name: Build, tag and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Docker/Dockerfile.milestones_api_swarm
          push: true
          cache-from: type=registry,ref=blueboardinc/milestones_api:latest
          cache-to: type=inline
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # the purpose of this pre-deploy job is simply to setup any variables needed for the deploy
  # job, as variables like environment and tag come from two different sources if this was involed
  # via a commit or a workflow_dispatch event
  pre-deploy:
    name: Pre-Deploy
    runs-on: ubuntu-latest
    needs:
      - build
    if: |
      always() && ( needs.build.result == 'success' || needs.build.result == 'skipped' )
    steps:
      - name: Use Environment and Tag from the tag job
        if: ${{ github.event_name != 'workflow_dispatch' }}
        run: |
          echo "Using the environment from the tag job: ${{ needs.tag.outputs.environment }}"
          echo "Using the tag from the tag job: ${{ needs.tag.outputs.tag }}"

      - name: Use Environment and Tag from workflow_dispatch
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "Using the tag from workflow_dispatch: ${{ github.event.inputs.tag }}"
          echo "Using the environment from workflow_dispatch: ${{ github.event.inputs.environment }}"

    outputs:
      environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || needs.tag.outputs.environment }}
      tag: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || needs.tag.outputs.tag }}

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs:
      - pre-deploy
    environment: ${{ needs.pre-deploy.outputs.environment }}
    env:
      TAG: ${{ needs.pre-deploy.outputs.tag != '' && needs.pre-deploy.outputs.tag || 'latest' }}
      ENVIRONMENT: ${{ needs.pre-deploy.outputs.environment != '' && needs.pre-deploy.outputs.environment || 'dev' }}
    if: |
      always() && ( needs.build.result == 'success' || needs.build.result == 'skipped' )
    steps:
      - name: Dump GitHub context (Debugging)
        if: ${{ env.DEBUG == 'true' }}
        run: |
          echo '${{ toJSON(github) }}'

      - name: Use the Docker Swarm Template (always from the dev branch üéóÔ∏è)
        if: ${{ github.event_name == 'workflow_dispatch' || needs.build.result == 'success' }}
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Checkout Blueboard's Shared GitHub Actions üîß
        if: ${{ github.event_name == 'workflow_dispatch' || needs.build.result == 'success' }}
        uses: actions/checkout@v4
        with:
          repository: blueboard/github_actions
          token: ${{ secrets.BLUEBOARD_BOT_PAT }}
          path: .github/actions

      - name: Install and configure Open VPN for ${{ env.ENVIRONMENT }}
        if: ${{ github.event_name == 'workflow_dispatch' || needs.build.result == 'success' }}
        uses: ./.github/actions/setup-open-vpn
        timeout-minutes: 1
        with:
          vpn_ca_crt_b64: ${{ env.ENVIRONMENT == 'prod' && secrets.PROD_VPN_CA_CRT_B64 || secrets.DEV_VPN_CA_CRT_B64 }}
          vpn_cert_crt_b64: ${{ env.ENVIRONMENT == 'prod' && secrets.PROD_VPN_CERT_CRT_B64 || secrets.DEV_VPN_CERT_CRT_B64 }}
          vpn_tls_key_b64: ${{ env.ENVIRONMENT == 'prod' && secrets.PROD_VPN_TLS_KEY_B64 || secrets.DEV_VPN_TLS_KEY_B64 }}
          username: ${{ env.ENVIRONMENT == 'prod' && secrets.PROD_VPN_SECRET_USERNAME || secrets.DEV_VPN_SECRET_USERNAME }}
          password: ${{ env.ENVIRONMENT == 'prod' && secrets.PROD_VPN_SECRET_PASSWORD || secrets.DEV_VPN_SECRET_PASSWORD }}
          vpn_cert_key_b64: ${{ env.ENVIRONMENT == 'prod' && secrets.PROD_VPN_CERT_KEY_B64 || secrets.DEV_VPN_CERT_KEY_B64 }}
          auth: ${{ env.ENVIRONMENT == 'prod' && 'SHA384' || 'SHA256' }}
          ssh_key_b64: ${{ env.ENVIRONMENT == 'prod' && secrets.PROD_SSH_KEY_B64 || secrets.DEV_SSH_KEY_B64 }}
          config: ${{ env.ENVIRONMENT == 'prod' && '.github/vpn/config-prod.ovpn' || '.github/vpn/config.ovpn' }}
          ping_host: ${{ env.ENVIRONMENT == 'prod' && secrets.PROD_LEADER || env.ENVIRONMENT == 'staging' && secrets.STAGING_LEADER || secrets.DEV_LEADER }}

      - name: Export all GitHub Secrets as Environment Variables
        if: ${{ github.event_name == 'workflow_dispatch' || needs.build.result == 'success' }}
        env:
          SECRETS: ${{ toJson(secrets) }}
        run: |
          # the purpose of this step is to export all GitHub secrets as regular
          # env vars so that we can use envsubst in a subsequent step
          # Note: jq adds double quotes around the value, so we must use sed to
          # re-wrap the values with single quotes, but still allowing for double
          # quotes in the env var itself, i.e. so that we end up with this:
          #
          # foo='foobar'
          # bar='barfoo'
          # foobar='bar"foo"foo'
          #
          echo $SECRETS | jq --raw-output '. | to_entries[] | .key + "=" + (.value | tojson)' | \
            sed "s/\=\"/\=\'/" | \
            sed "s/\"$/'/" | \
            sed "s/\"$/'/" >> $GITHUB_ENV
          unset SECRETS

      - name: Create the Docker Swarm Configuration
        if: ${{ github.event_name == 'workflow_dispatch' || needs.build.result == 'success' }}
        env:
          ENV: ${{ env.ENVIRONMENT }}
          IMAGE_TAG: ${{ env.TAG }}
          REPLICAS: ${{ vars.REPLICAS || 1 }}
        run: |
          # append the tag to form a fully qualified Docker tag
          export IMAGE_TAG="${{ env.MILESTONES_DOCKER_REPO }}:${IMAGE_TAG}"

          # do the env substitution and fix any issues with single quotes (more details in the Rails API)
          mv ${SWARM_YAML} ${SWARM_YAML}.orig && envsubst < ${SWARM_YAML}.orig > ${SWARM_YAML}

      - name: Timestamp the Docker Swarm Configuration
        if: ${{ github.event_name == 'workflow_dispatch' || needs.build.result == 'success' }}
        uses: ./.github/actions/stamp-swarm-config
        with:
          file: ${SWARM_YAML}

      - name: Copy Docker Swarm Configuration & Recycle Containers ‚ôªÔ∏è
        if: ${{ github.event_name == 'workflow_dispatch' || needs.build.result == 'success' }}
        uses: ./.github/actions/update-docker-swarm
        timeout-minutes: 1
        with:
          hosts: ${{ env.ENVIRONMENT == 'prod' && secrets.PROD_HOSTS || env.ENVIRONMENT == 'staging' && secrets.STAGING_HOSTS || secrets.DEV_HOSTS }}
          leader: ${{ env.ENVIRONMENT == 'prod' && secrets.PROD_LEADER || env.ENVIRONMENT == 'staging' && secrets.STAGING_LEADER || secrets.DEV_LEADER }}
          yaml_file: ${{ env.SWARM_YAML }}
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub_password: ${{ secrets.DOCKERHUB_TOKEN_RO }}
          app: "milestones_api"

      - name: Stop the VPN
        if: ${{ github.event_name == 'workflow_dispatch' || needs.build.result == 'success' }}
        run: |
          sudo chmod 444 vpn.log
          cat vpn.log
          sudo killall openvpn